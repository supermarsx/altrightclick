name: Build

on:
  # Build only after tests complete successfully, or manually
  workflow_run:
    workflows: ["Test"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-x64:
    name: Build (x64)
    runs-on: windows-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Configure (x64)
        run: cmake -S . -B build/x64 -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Generate icon (x64)
        run: cmake --build build/x64 --config Release --target generate_icon -- /m

      - name: Build (x64)
        run: cmake --build build/x64 --config Release -- /m

      - name: Upload build (x64)
        uses: actions/upload-artifact@v4
        with:
          name: build-x64
          path: build/x64

  build-arm64:
    name: Build (ARM64)
    runs-on: windows-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Configure (ARM64)
        run: cmake -S . -B build/arm64 -G "Visual Studio 17 2022" -A ARM64 -DCMAKE_BUILD_TYPE=Release

      - name: Generate icon (ARM64)
        run: cmake --build build/arm64 --config Release --target generate_icon -- /m

      - name: Build (ARM64)
        run: cmake --build build/arm64 --config Release -- /m

      - name: Upload build (ARM64)
        uses: actions/upload-artifact@v4
        with:
          name: build-arm64
          path: build/arm64

